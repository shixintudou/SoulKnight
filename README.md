# SoulKnight


## 写在前面
* 本游戏大部分时间在4k分辨率下开发，UI的显示会有问题（也可能是我不会设置）。
* 目前的UI显示情况：
 * 4k分辨率编辑器下显示正常。
 * 1080p分辨率编辑器下只能显示一小块UI，状态条和退出按钮均不可见。
 * 4k和1080p运行可执行文件时显示效果相同，但会空出屏幕。


## 游戏内容


### 操作
* WASD和上下左右控制人物移动。
* 左键攻击及手刀。
* E键使用技能。
* F键进门。
* R键拾取武器。
* Q键切换武器。

### 玩家
* 初始携带破旧的手枪。
* 技能为双枪。
* 目前玩家死亡时未做特殊处理，仅仅是玩家无法走动。
* 初始最多可携带两把武器。

### 武器
* 有四把武器：
 * 破旧的手枪：无蓝耗，攻速较慢，伤害较低。
 * 突击步枪：一次2蓝，攻速较快，伤害较高。
 * 光剑蓝：无蓝耗，近战武器。
 * 光剑红：2蓝耗，近战，可将敌人吸近，蓝量不足时不吸近。
* 武器未设攻速上限，理论上鼠标点多快就能打多快。

### 敌人
* 三种敌人：
 * 普通哥布林，近战，隔一定时间攻击玩家，目前无攻击特效。
 * 野猪：冲撞攻击。
 * 哥布林祭祀：远程，不会主动近身。
* 所有敌人都会有意识地躲避玩家的子弹。

### 地图
* 有起始地图和1-1到1-5共六张地图。
* 通过1-5后会回到起始地图。
* 地图会随机生成一到两波敌人，还会生成黄蓝水晶和武器宝箱。

### 其他物品
* 敌人和黄水晶会掉落金币，目前金币数量没有显示，且没有可购买物品。
* 拾取蓝水晶回复8点蓝。

### UI
* 进入游戏时为开始界面，点击进入游戏。
* 左上角显示蓝血盾。
* 右上角按钮点击后退出游戏。


## 程序实现

### 角色
* 角色控制用状态机实现，并把角色控制脚本设为单例，方便其他物体对角色的访问。
* 玩家状态包括基本状态，技能状态，护盾状态，三种状态间互为平行关系。
 * 基本状态主要控制动画的播放和死亡判定。
 * 通过GetAxisRaw切换待机和行走。
 * 技能状态控制技能的持续与冷却。
 * 当技能开始使用时开启技能使用协程，同时改变状态防止重复开启协程。
 * 技能结束后同样开启协程使技能恢复。
 * 玩家护盾不满时开启护盾准备恢复协程，同时改变状态防止重复开启。
 * 上述协程结束后开启护盾恢复协程，每隔一定时间恢复一点护盾，同样改变状态防止重复开启。
 * 玩家每次受到攻击都会终止护盾相关协程并改变护盾状态。
* 玩家的技能特效通过一个空的子物体实现，技能开启时该子物体播放动画。结束时停止播放。
* 玩家开启技能时通过Instianite复制当前武器，技能结束后销毁该武器，若中途切换武器则技能提前结束。
* 玩家手中的武器存储在一个list中，通过一个int索引获得当前武器。
* 按Q切换武器时若背包中有其他武器则当前武器Active设为false,更新索引，索引所指武器设为true。
* 技能克隆出的武器不会进入该list。
* 玩家的武器均为玩家的子物体。
* 拾取武器时更新list，超出上限时更新list的当前武器，将原武器解除父子关系放置到地图中。
* 玩家每次受到伤害时调用hurt()函数，开启QuitHurt协程，将有短暂时间硬直。
* 玩家的攻击由武器自身脚本实现，玩家控制脚本不参与其中。
* 玩家控制脚本中声明了获取鼠标坐标的方法。

### 武器
* 所有武器继承WeaponBase。
* WeaponBase声明了武器参数，以及判断武器拾取和判断手刀的方法。
* 武器不在玩家手中时，判断E键按下和玩家距离判定是否拾取。
* 通过改变transform.right使武器指向鼠标位置。
* 远程武器每当按下左键就会从子弹池获取一颗子弹，并通过调用玩家控制器中的方法获取鼠标坐标，传递给子弹发射方向。
* 同时开启协程，在按住左键时每隔一定时间生成一颗子弹，松开左键时结束协程。
* 玩家有一个自身有一个手刀空子物体，带有2d多边形trigger碰撞体。
* 远程武器通过调用该碰撞体的overlap（后面的字母忘了）方法，检测该区域是否有敌人，若有，则攻击方式变为手刀。
* 手刀的伤害数值在角色控制脚本中设置。
* 近战武器不调用手刀检测方法。
* 近战武器的剑气动画由子物体播放，父物体播放位移动画。
* 近战武器的判定方法与手刀类似，只是范围稍大。
* 近战武器同时判定敌人子弹，攻击时会将区域内敌人子弹Active设为false。
* 远程武器的伤害判定由子弹实现，子弹的伤害判定同上，子弹造成伤害或撞墙时直接将自身Active设为false。
* 子弹射出时会直接开启协程，10s后自动设Active为false。
* 蓝量不足时武器攻击会受限。

### 敌人
* 所有敌人继承EnemeyBase。
* 敌人ai通过状态机实现。
* 伤害判定同样调用overlap方法。
* 敌人离角色较远时随机移动。
* 角色进入攻击范围时近战敌人朝角色移动，远程敌人稍微拉近后保持距离。
* 每个敌人除碰撞体和刚体外，近战敌人还有判断攻击的trigger碰撞体。
* 远程敌人通过子弹池获取子弹，敌人子弹的各种判定和玩家子弹相同。
* 近战哥布林在接近玩家后开启攻击协程，每隔一段时间攻击一次玩家，伤害判定与玩家的近战武器相似。
* 野猪会加速朝玩家冲刺，判定同上，每一次撞击都会造成伤害，撞击成功后会停一小段时间。
* 目前近战敌人没有动画，攻击表现不太明显。
* 所有敌人都会通过射线检测判断前方是否有玩家子弹，若有则会开启闪避协程。采用射线检测可以让闪避不太频繁。
* 敌人死后随机生成一个硬币或蓝水晶，生成采用Resources.Load。

### 地图
* 每块地图都由基本地图块构成。
* 地图块包括地面，墙壁，栅栏，路。
* 每块地图间距相同。
* 初始时栅栏和路均为false。
* 生成地图由MapSetter完成，MapSetter为单例。
* MapSetter定义了一个二维布尔数组，每个场景开始时从中间开始随机生成，把地图块位置设为true。
* 根据二维数组生成地图位置，并记录起始位置。
* 每个地图块都有MapController脚本。
* 地图块有一个trigger碰撞体，同样通过上述方法判断玩家是否进入。
* 初始地图判断四周地图位置生成路径。
* 玩家进入地图块后，若生成敌人，会将四面栅栏设为true，并把生成的敌人存入list，记录波次。
* 遍历list判断敌人是否死亡，全部死亡后若波次未到则回到上一个状态，否则生成宝箱，并根据周围地图块设置栅栏和路径，之后将状态设为已探索，不再做任何动作。
* 设置栅栏路径时，首先根据自身transform找到自己在二维数组中的位置，然后遍历上下左右四个方位。
* 玩家每探索完一个地图，MapSetter中的mapNumber++。
* 在MapSetter中会随机生成一个奖励房和特殊房的number。
* 若玩家探索到奖励和特殊房，则房间状态直接为已探索，并设置栅栏路径。
* mapNumber等于地图数目时，会在最后一个房间生成一个门，按F进入下一关。

### 地图物品
* 宝箱：
 * 宝箱在玩家靠近后直接销毁，并生成物品。
 * 游戏中weaponname物体用list存储了武器名字并设为单例，武器宝箱通过索引生成武器。
 * 普通宝箱随机生成一定量的硬币和蓝水晶。
* 大黄水晶和大蓝水晶：
 * 继承EnemyBase。
 * HP降为零后生成对应物品，同时更换精灵图，碰撞体enable设为false。

### UI
* 开始图片为image，点击后设为false。
* 右上角退出键为button。
* 左上角状态条通过控制缩放显示状态。


## 插件与包
* 本游戏开发过程中未使用任何第三方插件/包。


## 代码架构
* 玩家由PlayerController脚本控制。
* 该脚本为单例，并实现了状态机。
* 由于PlayerController为最早编写的脚本之一，因此出现了一些设计失误：
 * 玩家的攻击由武器执行，因此Attack状态显得多余。
 * WeaponState以及CloseWeaPonRange,FarWeaponRange同样显得多余。
 * 在最终的成品中，这些都没有得到调用,CloseWeaponRange还限制了近战武器的攻击范围。
* 实现了敌人对象池和子弹对象池：
 * 子弹池根据参数返回所需子弹，对象用list存储。
 * 敌人池对象用queue存储，循环返回敌人。
 * 在需要扩展时对象池可以扩展。
 * 对象池设为单例。
* 敌人：
 * 敌人都继承自EnemeyBase。
 * 敌人ai由状态机实现。
 * 伤害判定时通过查找EnemeyBase造成伤害。
 * 可破坏物品同样继承EnemyBase。
 * EnemyBase中定义了敌人的状态和各种数值。
* 武器：
 * 武器都继承自WeaPonBase。
 * WeaponBase定义了武器数值好和公共的拾取方法。
 * 武器自身处理攻击事件。